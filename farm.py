#!/usr/bin/env python3

import asyncio
# from exploits import exploit
import collections

import settings
from backends.hackerdom_flag_submitter import HackerdomFlagSubmitter
from exploits.Ssss import Ssss
from exploits.Tttt import Tttt
from farm.farms import Farm
from farm.models import Team
from farm.storage import DirectoryFlagStorage

EXPLOITS = {}
EXPLOITS_DIR = "exploits"
EXPLOITS_TIMEOUT = 50


async def run_exploit(ips, exploit):
    while True:
        try:
            coroutines = [exploit.attack(ip) for ip in ips]
            completed, pending = await asyncio.wait(coroutines) # тут видимо надо бы понять, как по таймауту отваливаться
            for c in completed:
                log("exploit on ip %s done" % c) # надо бы понять, с какого ip делался запрос
            for c in pending:
                log("exploit on ip %s pending" % c)  # надо бы понять, с какого ip делался запрос
            result = [c.result for c in completed]
            # положить результат куда-нибудь
        except:
            pass
        finally:
            pass


def log(s):
    print(s)


def get_all_exploits():
    from os import listdir
    from os.path import isfile, join, isdir, splitext
    if not isdir(EXPLOITS_DIR):
        log("exploits/ not a dir")
        return

    files = [file for file in listdir(EXPLOITS_DIR) if isfile(join(EXPLOITS_DIR, file))]
    for file in files:
        module, ext = splitext(file)

        if ext != ".py" or module in EXPLOITS:
            continue

        log("find module %s" % module)
        exec("from %s import %s" % (EXPLOITS_DIR, module))
        exec("EXPLOITS['%s'] = %s.Exploit()" % (module, module))
        log("module %s successfully imported" % module)
    log(EXPLOITS)


if __name__ == '__main__':
    # get_all_exploits()
    # event_loop = asyncio.get_event_loop()
    # try:
    #     event_loop.run_until_complete(run_exploit(["1", "2", "3"], EXPLOITS["Task_name"]))
    # finally:
    #     event_loop.close()
    f = Farm(
        [Team('Sasha', '555')],
        [Tttt(), Ssss()],
        HackerdomFlagSubmitter('127.0.0.1', ''),
        DirectoryFlagStorage('flags'),
        settings.FLAG_FORMAT
    )
    f.run()
